<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Green Heaven - Menu</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer.css') }}">
    <!-- Preload critical resources for faster loading -->
    <link rel="preload" hr        // Place order
        function placeOrder() {
            console.log('üìã Place order clicked');
            
            const items = Object.values(simpleCart);
            if (items.length === 0) {
                console.log('‚ùå Cannot place order: cart is empty');
                return;
            }://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"></noscript>
    <!-- Load Font Awesome asynchronously -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></noscript>
</head>
<body>
    <div class="customer-app">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="restaurant-info">
                    <div class="brand-section">
                        <img src="{{ url_for('static', filename='logo.png') }}" alt="Green Heaven Logo" class="logo">
                        <div class="brand-text">
                            <h1>Green Heaven</h1>
                            <p>Katuneriya, Sri Lanka</p>
                            <small class="tagline">Where Nature Becomes Flavor</small>
                        </div>
                    </div>
                </div>
                <div class="customer-info">
                    <div class="welcome">
                        <span class="customer-name">{{ customer_name }}</span>
                        <span class="table-info">Table {{ table_number }}</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Order Status Section -->
        <div class="order-status-section" id="order-status-section" style="display: none;">
            <div class="status-header">
                <h3><i class="fas fa-receipt"></i> Your Order Status</h3>
                <button class="toggle-status-btn" id="toggle-status-btn">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="status-content" id="status-content">
                <div class="order-progress">
                    <div class="progress-step" data-status="pending">
                        <div class="step-icon"><i class="fas fa-clock"></i></div>
                        <span>Order Received</span>
                    </div>
                    <div class="progress-step" data-status="preparing">
                        <div class="step-icon"><i class="fas fa-chef-hat"></i></div>
                        <span>Preparing</span>
                    </div>
                    <div class="progress-step" data-status="ready">
                        <div class="step-icon"><i class="fas fa-check-circle"></i></div>
                        <span>Ready to Serve</span>
                    </div>
                </div>
                <div class="current-orders" id="current-orders">
                    <!-- Orders will be populated here -->
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="call-staff-btn" id="call-staff-btn" onclick="callStaff()">
                <i class="fas fa-bell"></i>
                <span>Call Staff</span>
            </button>
            <button class="cart-btn" id="cart-btn" onclick="showCart()">
                <i class="fas fa-shopping-cart"></i>
                <span>Cart (<span id="cart-count">0</span>)</span>
                <span class="cart-total">LKR <span id="cart-total">0.00</span></span>
            </button>
        </div>

        <!-- Menu Categories -->
        <div class="menu-categories">
            <button class="category-btn active" data-category="all">All Items</button>
            <button class="category-btn" data-category="Starters">Starters</button>
            <button class="category-btn" data-category="Soup">Soup</button>
            <button class="category-btn" data-category="Sandwiches">Sandwiches</button>
            <button class="category-btn" data-category="Salads">Salads</button>
            <button class="category-btn" data-category="Main Dishes">Main Dishes</button>
            <button class="category-btn" data-category="Rice">Rice</button>
            <button class="category-btn" data-category="Noodles">Noodles</button>
            <button class="category-btn" data-category="Pasta">Pasta</button>
            <button class="category-btn" data-category="Grill Recipes">Grill</button>
            <button class="category-btn" data-category="Side Dishes">Sides</button>
        </div>

        <!-- Menu Items -->
        <div class="menu-container">
            <div class="menu-grid" id="menu-grid">
                {% for item in menu_items %}
                <div class="menu-item" data-category="{{ item.category }}" data-item-id="{{ item.id }}">
                    <div class="menu-item-image">
                        {% if item.image %}
                        <img src="{{ item.image }}" alt="{{ item.name }}">
                        {% else %}
                        <div class="image-placeholder">
                            <i class="fas fa-utensils"></i>
                        </div>
                        {% endif %}
                    </div>
                    <div class="menu-item-content">
                        <h3 class="item-name">{{ item.name }}</h3>
                        <p class="item-description">{{ item.description }}</p>
                        <div class="item-footer">
                            <span class="item-price">LKR {{ "%.2f"|format(item.price) }}</span>
                            <div class="quantity-controls">
                                <button class="qty-btn minus" onclick="updateQuantity('{{ item.id }}', -1)">-</button>
                                <span class="quantity" id="qty-{{ item.id }}">0</span>
                                <button class="qty-btn plus" onclick="updateQuantity('{{ item.id }}', 1)">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Cart Modal -->
        <div class="modal" id="cart-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-shopping-cart"></i> Your Order</h2>
                    <button class="close-modal" id="close-cart-modal" onclick="hideCart()">&times;</button>
                </div>
                <div class="modal-body">
                    <div id="cart-items"></div>
                    <div class="cart-summary">
                        <div class="total-row">
                            <strong>Total: LKR <span id="final-total">0.00</span></strong>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-secondary" id="close-cart-modal-btn" onclick="hideCart()">Continue Shopping</button>
                    <button class="btn-primary" id="place-order-btn" onclick="placeOrder()">Place Order</button>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal" id="confirmation-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-check-circle"></i> Order Confirmed!</h2>
                </div>
                <div class="modal-body">
                    <p>Your order has been sent to the kitchen.</p>
                    <p>We'll notify you when it's ready!</p>
                    <div class="order-status">
                        <span id="order-status-text">Order Received</span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="close-confirmation-btn">Continue</button>
                </div>
            </div>
        </div>

        <!-- Call Staff Success Modal -->
        <div class="modal" id="call-success-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-bell"></i> Staff Notified!</h2>
                </div>
                <div class="modal-body">
                    <p>Our staff has been notified and will be with you shortly.</p>
                    <p>Thank you for your patience!</p>
                </div>
                <div class="modal-footer">
                    <button class="btn-primary" id="close-call-success-btn">OK</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio for notifications -->
    <audio id="notification-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwPKCKE3NrMeR8BMGw=" type="audio/wav">
    </audio>

    <!-- Load Socket.IO from local source or CDN fallback (non-blocking) -->
    <script>
        // Load Socket.IO asynchronously to avoid blocking
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.socket.io/4.5.4/socket.io.min.js';
            script.async = true;
            script.onload = function() {
                console.log('‚úÖ Socket.IO loaded');
            };
            script.onerror = function() {
                console.warn('‚ö†Ô∏è Socket.IO CDN failed, some features may not work');
            };
            document.head.appendChild(script);
        })();
        
        // Load Supabase client for real-time subscriptions
        (function() {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
            script.async = true;
            script.onload = function() {
                console.log('üöÄ Supabase client loaded for real-time updates');
                initializeSupabaseRealtime();
            };
            script.onerror = function() {
                console.warn('‚ö†Ô∏è Supabase client failed to load');
            };
            document.head.appendChild(script);
        })();
    </script>
    <script>
        // Customer data - available immediately
        const customerName = "{{ customer_name }}";
        const tableNumber = "{{ table_number }}";
        
        // Simple cart object
        let simpleCart = {};
        
        // Menu items - globally available for customer.js
        window.menuItemsData = {{ menu_items | tojson | safe }};
        
        // IMMEDIATE WORKING FUNCTIONS - Available right away
        
        // Update quantity function that works immediately
        function updateQuantity(itemId, change) {
            console.log('ÔøΩ updateQuantity called:', itemId, change);
            
            const quantityEl = document.getElementById(`qty-${itemId}`);
            if (!quantityEl) {
                console.error('‚ùå Quantity element not found for item:', itemId);
                return;
            }
            
            const currentQty = parseInt(quantityEl.textContent) || 0;
            const newQty = Math.max(0, currentQty + change);
            
            // Update display
            quantityEl.textContent = newQty;
            
            // Find item data
            const item = window.menuItemsData.find(item => item.id === itemId);
            if (!item) {
                console.error('‚ùå Item not found:', itemId);
                return;
            }
            
            // Update simple cart
            if (newQty === 0) {
                delete simpleCart[itemId];
            } else {
                simpleCart[itemId] = {
                    id: itemId,
                    name: item.name,
                    price: item.price,
                    quantity: newQty
                };
            }
            
            // Update cart display
            updateCartDisplay();
            
            console.log('‚úÖ Cart updated:', simpleCart);
        }
        
        // Update cart display
        function updateCartDisplay() {
            const items = Object.values(simpleCart);
            const totalItems = items.reduce((sum, item) => sum + item.quantity, 0);
            const totalPrice = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cart-count').textContent = totalItems;
            document.getElementById('cart-total').textContent = totalPrice.toFixed(2);
            
            console.log('üõí Cart display updated:', totalItems, 'items, LKR', totalPrice.toFixed(2));
        }
        
        // Call staff function that works immediately
        function callStaff() {
            console.log('üìû Call staff clicked');
            
            const data = {
                customer_name: customerName,
                table_number: tableNumber
            };
            
            // Show loading
            const btn = document.getElementById('call-staff-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calling...';
            btn.disabled = true;
            
            fetch('/api/call-staff', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Call staff response:', data);
                alert('‚úÖ ' + data.message);
            })
            .catch(error => {
                console.error('‚ùå Call staff error:', error);
                alert('‚ùå Failed to call staff. Please try again.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        // Show cart modal
        function showCart() {
            console.log('üõí Show cart clicked');
            
            populateCartModal();
            document.getElementById('cart-modal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        // Populate cart modal
        function populateCartModal() {
            const cartItemsContainer = document.getElementById('cart-items');
            const items = Object.values(simpleCart);
            
            if (items.length === 0) {
                cartItemsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        <i class="fas fa-shopping-cart" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                        <h3>Your cart is empty</h3>
                        <p>Add some delicious items from our menu!</p>
                    </div>
                `;
                document.getElementById('final-total').textContent = '0.00';
                document.getElementById('place-order-btn').disabled = true;
                return;
            }
            
            // Enable place order button
            document.getElementById('place-order-btn').disabled = false;
            
            cartItemsContainer.innerHTML = items.map(item => `
                <div class="cart-item">
                    <div class="cart-item-info">
                        <h4>${item.name}</h4>
                        <div class="cart-item-details">${item.quantity} √ó LKR ${item.price.toFixed(2)}</div>
                    </div>
                    <div class="cart-item-price">LKR ${(item.price * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');
            
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            document.getElementById('final-total').textContent = total.toFixed(2);
        }
        
        // Hide cart modal
        function hideCart() {
            document.getElementById('cart-modal').classList.remove('active');
            document.body.style.overflow = 'auto';
        }
        
        // Place order
        function placeOrder() {
            console.log('ÔøΩ Place order clicked');
            
            const items = Object.values(simpleCart);
            if (items.length === 0) {
                alert('Your cart is empty');
                return;
            }
            
            const total = items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            const orderData = {
                customer_name: customerName,
                table_number: tableNumber,
                items: items,
                total: total
            };
            
            // Show loading
            const btn = document.getElementById('place-order-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Placing Order...';
            btn.disabled = true;
            
            fetch('/api/place-order', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(orderData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ Order placed:', data);
                alert('‚úÖ Order placed successfully! Order ID: ' + data.order_id);
                
                // Clear cart
                simpleCart = {};
                updateCartDisplay();
                
                // Reset quantities
                document.querySelectorAll('.quantity').forEach(el => el.textContent = '0');
                
                // Hide modal
                hideCart();
            })
            .catch(error => {
                console.error('‚ùå Order placement error:', error);
                alert('‚ùå Failed to place order. Please try again.');
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
        
        // Make functions globally available
        window.updateQuantity = updateQuantity;
        window.callStaff = callStaff;
        window.showCart = showCart;
        window.hideCart = hideCart;
        window.placeOrder = placeOrder;
        
        // Debug logging
        console.log('üè∑Ô∏è Customer:', customerName, 'Table:', tableNumber);
        console.log('üì¶ Menu data loaded:', window.menuItemsData ? window.menuItemsData.length : 0, 'items');
        console.log('‚úÖ All functions ready immediately!');
    </script>
    <script src="{{ url_for('static', filename='js/customer.js') }}"></script>
</body>
</html>